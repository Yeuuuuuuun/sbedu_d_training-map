<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연수 지도 — 서대문·마포·은평</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster (겹침 방지) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- dayjs (날짜 파싱/비교) -->
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/customParseFormat.js"></script>
  <style>
    :root{
      --bg:#0b1020; --panel:#10162a; --ink:#e7ecff; --muted:#9fb0ff; --brand:#6ea8fe;
      --ok:#4ade80; --warn:#fbbf24; --danger:#fb7185; --chip:#1b2342; --card:#0f1530; --border:#213056;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,AppleSDGothicNeo,Segoe UI,Roboto,Pretendard,Malgun Gothic,Apple Color Emoji,Noto Color Emoji; color:var(--ink); background:linear-gradient(180deg,#080c1a,#0b1020 40%)}
    .app{display:grid; grid-template-columns:320px 1fr; gap:10px; height:100%;}
    aside{background:var(--panel); padding:14px 14px 10px; border-right:1px solid var(--border); overflow:auto}
    h1{font-size:18px; margin:0 0 10px; font-weight:700}
    .sub{color:var(--muted); font-size:12px; margin-bottom:12px}
    .filters{display:grid; gap:10px;}
    fieldset{border:1px solid var(--border); border-radius:10px; padding:10px}
    legend{padding:0 8px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    input, select, button{background:#0b1226; border:1px solid var(--border); color:var(--ink); border-radius:8px; padding:8px}
    button{cursor:pointer}
    button.primary{background:var(--brand); border-color:transparent; color:#06122c; font-weight:700}
    button.ghost{background:transparent; border-color:var(--border)}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{background:var(--chip); color:var(--muted); font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border)}
    .legend{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
    .legend .item{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)}
    .dot{width:12px; height:12px; border-radius:50%}
    #map{height:100%; width:100%; border-left:1px solid var(--border)}
    .footer{display:flex; gap:8px; margin-top:10px}
    .note{font-size:12px; color:var(--muted)}
    .todo{margin-top:10px; background:#0b1226; border:1px dashed var(--border); padding:10px; border-radius:8px}
    .todo h3{margin:0 0 6px; font-size:13px; color:var(--muted)}

    /* 커스텀 마커: DivIcon */
    .marker{
      width:18px; height:18px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.3);
      display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; color:#000; border:1px solid rgba(0,0,0,.35)
    }
    .marker.single{background:var(--mcolor);}
    .marker.split{background:conic-gradient(var(--mcolorA) 0 50%, var(--mcolorB) 0 100%);} /* 50:50 */
    .marker .inner{width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.85)}

    /* 팝업 스타일 */
    .popup h3{margin:0 0 6px; font-size:14px}
    .popup .addr{color:var(--muted); font-size:12px; margin-bottom:8px}
    .popup .sess{display:grid; gap:6px}
    .popup .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border); background:#0b1226; color:var(--muted)}

    .list{margin-top:10px; display:grid; gap:6px}
    .card{border:1px solid var(--border); border-radius:10px; padding:8px; background:#0b1226}
    .card h4{margin:0 0 6px; font-size:13px}
    .card .meta{font-size:12px; color:var(--muted)}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1226; border:1px solid var(--border); padding:1px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <h1>연수 지도</h1>
      <div class="sub">서대문구 · 마포구 · 은평구 — 과정별 색상/반반 마커, 날짜·과정 필터, 클릭 시 상세 보기</div>

      <div class="filters">
        <fieldset>
          <legend>구 선택</legend>
          <div class="row">
            <label><input type="checkbox" class="f-gu" value="서대문구" checked> 서대문구</label>
            <label><input type="checkbox" class="f-gu" value="마포구" checked> 마포구</label>
            <label><input type="checkbox" class="f-gu" value="은평구" checked> 은평구</label>
          </div>
        </fieldset>
        <fieldset>
          <legend>날짜 범위 (2025)</legend>
          <div class="row">
            <input type="date" id="dateStart"> ~ <input type="date" id="dateEnd">
            <button id="btnToday" class="ghost">전체</button>
          </div>
        </fieldset>
        <fieldset>
          <legend>연수 과정</legend>
          <div id="courseChecks" class="row"></div>
          <div class="legend" id="legend"></div>
        </fieldset>
        <div class="row">
          <button id="btnApply" class="primary">필터 적용</button>
          <button id="btnReset" class="ghost">초기화</button>
        </div>
      </div>

      <div class="todo">
        <h3>좌표 설정 (1회)</h3>
        <div class="note">처음 실행 시 주소의 좌표가 없으니, 아래 목록에서 학교를 선택하고 지도에서 위치를 <b>클릭</b>해 좌표를 저장하세요. 좌표는 브라우저 <b>localStorage</b>에 저장되며 <span class="kbd">내보내기</span> 버튼으로 JSON으로 저장할 수 있습니다.</div>
        <div class="row" style="margin-top:6px">
          <select id="selPlace" style="flex:1"></select>
          <button id="btnExport" class="ghost">좌표 JSON 내보내기</button>
        </div>
      </div>

      <div class="list" id="missingList"></div>

      <div class="footer">
        <span class="note">Tip: 지도에서 <span class="kbd">Shift+드래그</span>로 영역 확대</span>
      </div>
    </aside>
    <div id="map"></div>
  </div>

<script>
// =============================
// 1) 원본 데이터 (표 → 배열)
// =============================
// 주의: 연도는 2025년 가정. 요일 텍스트는 무시하고, HH:MM~HH:MM 파싱
const RAW = [
  ["S1","염리초","9.15.","14:30","16:10","⑤평가 익스프레스","서울 마포구 토정로37길 37"],
  ["S2","홍제초","9.16.","14:30","16:10","②AI관람차","서울 서대문구 홍은중앙로 13"],
  ["S3","어울초","9.16.","15:00","16:40","⑤평가 익스프레스","서울 은평구 통일로 650"],
  ["S4","인왕초","9.16.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 세무서길 33-9"],
  ["S5","가재울초","9.17.","14:00","15:40","④수업 바이킹","서울 서대문구 모래내로15길 61"],
  ["S6","연신초","9.17.","14:00","15:40","④수업 바이킹","서울 은평구 연서로 347"],
  ["S7","성산초","9.17.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 양화로3길 94"],
  ["S8","신사초","9.17.","14:50","16:30","②AI관람차","서울 은평구 가좌로 275-2"],
  ["S9","금화초","9.18.","15:00","16:40","①에듀테크 주토피아","서울 서대문구 통일로 165"],
  ["S10","금화초","9.18.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 통일로 165"],
  ["S11","은진초","9.22.","15:00","16:40","①에듀테크 주토피아","서울 은평구 진관1로 21-20"],
  ["S12","소의초","9.22.","15:00","16:40","②AI관람차","서울 마포구 마포대로24길 42"],
  ["S13","신도초","9.22.","15:00","16:40","①에듀테크 주토피아","서울 은평구 진관1로 77-23"],
  ["S14","홍연초","9.23.","14:30","16:10","①에듀테크 주토피아","서울 서대문구 백련사길 55"],
  ["S15","성원초","9.23.","15:00","16:40","⑦파라오의 학급경영","서울 마포구 월드컵로36길 34"],
  ["S16","구산초","9.24.","14:30","16:10","②AI관람차","서울 은평구 서오릉로15길 16"],
  ["S17","북성초","9.24.","14:30","16:10","⑦파라오의 학급경영","서울 서대문구 북아현로1나길 22"],
  ["S18","중동초","9.24.","14:40","16:20","④수업 바이킹","서울 마포구 월드컵북로 152"],
  ["S19","연은초","9.25.","14:40","16:10","⑤평가 익스프레스","서울 은평구 백련산로2길 35"],
  ["S20","마포초","9.29.","14:40","16:20","①에듀테크 주토피아","서울 마포구 도화2길 64"],
  ["S21","마포초","9.29.","14:40","16:20","②AI관람차","서울 마포구 도화2길 64"],
  ["S22","연광초","9.30.","14:30","16:10","②AI관람차","서울 은평구 연서로35길 37"],
  ["S23","경기초","9.30.","15:20","17:00","④수업 바이킹","서울 서대문구 경기대로9길 10"],
  ["S24","갈현초","10.1.","14:40","16:20","④수업 바이킹","서울 은평구 연서로29길 31"],
  ["S25","증산초","10.13.","15:00","16:40","⑦파라오의 학급경영","서울 은평구 증산서길 61"],
  ["S26","신북초","10.14.","14:50","16:20","⑤평가 익스프레스","서울 마포구 월드컵북로38길 26"],
  ["S27","명지초","10.15.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 명지2길 32-20"],
  ["S28","수색초","10.15.","15:00","16:40","④수업 바이킹","서울 은평구 수색로16길 21"],
  ["S29","예일초","10.20.","14:30","16:10","①에듀테크 주토피아","서울 은평구 연서로 117"],
  ["S30","이대부초","10.21.","15:30","17:10","④수업 바이킹","서울 서대문구 성산로 512-39"],
  ["S31","고은초","10.22.","15:00","16:40","④수업 바이킹","서울 서대문구 모래내로 441"],
  ["S32","응암초","10.22.","14:30","16:10","⑤평가 익스프레스","서울 은평구 가좌로6길 20"],
  ["S33","응암초","10.22.","14:30","16:10","⑥업무 레볼루션","서울 은평구 가좌로6길 20"],
  ["S34","구현초","11.3.","14:50","16:30","②AI관람차","서울 은평구 갈현로15길 51"],
  ["S35","수리초","11.3.","15:00","16:40","②AI관람차","서울 은평구 불광로14길 10-10"],
  ["S36","대은초","11.4.","14:30","16:10","⑥업무 레볼루션","서울 은평구 통일로69길 12-15"],
  ["S37","녹번초","11.5.","14:00","15:40","⑥업무 레볼루션","서울 은평구 녹번로1길 1"],
  ["S38","녹번초","11.5.","14:00","15:40","②AI관람차","서울 은평구 녹번로1길 1"],
  ["S39","안산초","11.5.","14:00","15:40","⑦파라오의 학급경영","서울 서대문구 통일로 321"],
  ["S40","충암초","11.5.","14:30","15:10","⑥업무 레볼루션","서울 은평구 가좌로5길 5"],
  ["S41","공덕초","11.11.","14:30","16:20","⑥업무 레볼루션","서울 마포구 만리재옛길 13"],
  ["S42","한서초","11.12.","14:00","15:40","①에듀테크 주토피아","서울 마포구 대흥로24바길 27"],
  ["S43","아현초","11.12.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 굴레방로 6"],
  ["S44","상암초","11.17.","14:50","16:30","⑥업무 레볼루션","서울 마포구 월드컵북로 353"],
  ["S45","불광초","11.19.","14:30","16:10","⑥업무 레볼루션","서울 은평구 불광로 51"],
  ["S46","홍대부초","11.19.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 성미산로 51"]
];

// 과정 심볼→이름 & 색상 팔레트
const COURSE = {
  '①에듀테크 주토피아': { key:'C1', name:'에듀테크 주토피아', color:'#6ee7b7' },
  '②AI관람차': { key:'C2', name:'AI관람차', color:'#93c5fd' },
  '③(미사용)': { key:'C3', name:'(미사용)', color:'#a78bfa' },
  '④수업 바이킹': { key:'C4', name:'수업 바이킹', color:'#fca5a5' },
  '⑤평가 익스프레스': { key:'C5', name:'평가 익스프레스', color:'#fcd34d' },
  '⑥업무 레볼루션': { key:'C6', name:'업무 레볼루션', color:'#f9a8d4' },
  '⑦파라오의 학급경영': { key:'C7', name:'파라오의 학급경영', color:'#60a5fa' }
};

// 날짜 파서 준비
dayjs.extend(dayjs_plugin_customParseFormat);

// 주소에서 자치구 추출(서대문구/마포구/은평구)
function parseGu(addr){
  if(!addr) return ''; if(addr.includes('서대문구')) return '서대문구';
  if(addr.includes('마포구')) return '마포구'; if(addr.includes('은평구')) return '은평구';
  return '';
}

// RAW → school 기반으로 병합
function buildDataset(){
  const map = new Map();
  for(const r of RAW){
    const [id, school, md, start, end, courseText, addr] = r;
    const gu = parseGu(addr);
    // 월.일. → 2025-MM-DD
    const mdNorm = md.replace(/\s*/g,''); // e.g. 10.1.
    const [mStr,dStr] = mdNorm.split('.').filter(Boolean); // ['10','1']
    const yyyy = 2025;
    const mm = String(mStr).padStart(2,'0');
    const dd = String(dStr).padStart(2,'0');
    const startIso = dayjs(`${yyyy}-${mm}-${dd} ${start}`, 'YYYY-MM-DD HH:mm').toISOString();
    const endIso = dayjs(`${yyyy}-${mm}-${dd} ${end}`, 'YYYY-MM-DD HH:mm').toISOString();

    const key = school+'@@'+addr; // 동일 학교+주소는 한 점으로 묶음
    if(!map.has(key)){
      map.set(key, { id: key, school, addr, gu, sessions: [], courses: new Set(), lat:null, lng:null });
    }
    const e = map.get(key);
    e.sessions.push({ id, date:startIso, end:endIso, course:courseText });
    e.courses.add(courseText);
  }
  // 좌표 캐시(localStorage) 반영
  const cache = loadCoordCache();
  const out = Array.from(map.values()).map(v=>{
    const cacheKey = v.school+'@@'+v.addr;
    if(cache[cacheKey]){ v.lat = cache[cacheKey].lat; v.lng = cache[cacheKey].lng; }
    v.courses = Array.from(v.courses);
    return v;
  });
  return out;
}

// 좌표 캐시
function loadCoordCache(){
  try{ return JSON.parse(localStorage.getItem('coord_cache')||'{}'); }catch{return {}}}
function saveCoordCache(obj){ localStorage.setItem('coord_cache', JSON.stringify(obj)); }
function setCoordFor(item, latlng){
  const cache = loadCoordCache();
  cache[item.school+'@@'+item.addr] = { lat:latlng.lat, lng:latlng.lng };
  saveCoordCache(cache);
}

// 지도와 마커 관리
let map, cluster;
function initMap(){
  map = L.map('map',{ zoomControl:true }).setView([37.5665, 126.9780], 12); // 서울 중심
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'© OpenStreetMap'
  }).addTo(map);
  cluster = L.markerClusterGroup({ disableClusteringAtZoom:16 });
  map.addLayer(cluster);
}

function markerIcon(courses){
  // 1개면 단색, 2개면 반반. 기타는 첫 두 색 반반.
  const c1 = COURSE[courses[0]]?.color || '#bbb';
  const c2 = courses[1] ? (COURSE[courses[1]]?.color || '#888') : null;
  if(!c2){
    return L.divIcon({className:'marker single', html:`<div class="inner"></div>`, iconSize:[18,18], iconAnchor:[9,9] , bgPos:[0,0]});
  }
  // split
  const el = document.createElement('div'); el.className='marker split';
  el.style.setProperty('--mcolorA', c1);
  el.style.setProperty('--mcolorB', c2);
  el.innerHTML = '<div class="inner"></div>';
  return L.divIcon({ className:'', html:el, iconSize:[18,18], iconAnchor:[9,9]});
}

function colorOf(course){ return COURSE[course]?.color || '#888'; }

function renderLegend(){
  const lg = document.getElementById('legend'); lg.innerHTML='';
  Object.values(COURSE).filter(c=>c.key!=='C3').forEach(c=>{
    const item = document.createElement('div'); item.className='item';
    const dot = document.createElement('div'); dot.className='dot'; dot.style.background=c.color;
    item.append(dot, document.createTextNode(c.name)); lg.append(item);
  });
}

function sessionHtml(s){
  const d = dayjs(s.date).format('M.D(ddd) HH:mm');
  const e = dayjs(s.end).format('HH:mm');
  return `<div><span class="pill">${COURSE[s.course]?.name||s.course}</span> · ${d} ~ ${e}</div>`
}

function popupHtml(item){
  const wrap = document.createElement('div'); wrap.className='popup';
  const h3 = document.createElement('h3'); h3.textContent = item.school; wrap.appendChild(h3);
  const addr = document.createElement('div'); addr.className='addr'; addr.textContent = item.addr; wrap.appendChild(addr);
  const sess = document.createElement('div'); sess.className='sess';
  item.sessions.sort((a,b)=>a.date.localeCompare(b.date)).forEach(s=>{ sess.insertAdjacentHTML('beforeend', sessionHtml(s));});
  wrap.appendChild(sess);
  return wrap;
}

let DATA = buildDataset();
let markers = [];

function clearMarkers(){ cluster.clearLayers(); markers=[]; }

function addMarkers(list){
  list.forEach(item=>{
    if(item.lat==null || item.lng==null) return; // 좌표 없는 건 건너뜀
    const ic = markerIcon(item.courses);
    if(ic.options.className==='marker single'){
      ic.options.html = `<div class="marker single" style="--mcolor:${colorOf(item.courses[0])}"><div class="inner"></div></div>`;
    }
    const m = L.marker([item.lat, item.lng], { icon: ic });
    m.bindPopup(popupHtml(item));
    cluster.addLayer(m); markers.push(m);
  });
}

// 필터 UI 구성
function buildCourseChecks(){
  const box = document.getElementById('courseChecks'); box.innerHTML='';
  const keys = Object.keys(COURSE).filter(k=>k!=='③(미사용)');
  keys.forEach(k=>{
    const id = 'c_'+COURSE[k].key; const lab = document.createElement('label');
    lab.innerHTML = `<input type="checkbox" class="f-course" id="${id}" value="${k}" checked> ${COURSE[k].name}`;
    box.appendChild(lab);
  });
}

function getFilter(){
  const gu = Array.from(document.querySelectorAll('.f-gu:checked')).map(x=>x.value);
  const cs = Array.from(document.querySelectorAll('.f-course:checked')).map(x=>x.value);
  const ds = document.getElementById('dateStart').value;
  const de = document.getElementById('dateEnd').value;
  const start = ds ? dayjs(ds).startOf('day') : null;
  const end = de ? dayjs(de).endOf('day') : null;
  return { gu, courses:cs, start, end };
}

function passFilter(item, F){
  if(F.gu.length && !F.gu.includes(item.gu)) return false;
  if(F.courses.length){
    // 세션 중 하나라도 선택 과정에 해당하면 표시
    const ok = item.sessions.some(s=>F.courses.includes(s.course));
    if(!ok) return false;
  }
  if(F.start || F.end){
    const ok = item.sessions.some(s=>{
      const d = dayjs(s.date);
      if(F.start && d.isBefore(F.start)) return false;
      if(F.end && d.isAfter(F.end)) return false;
      return true;
    });
    if(!ok) return false;
  }
  return true;
}

function applyFilter(){
  const F = getFilter();
  const list = DATA.filter(d=>passFilter(d,F));
  clearMarkers(); addMarkers(list);
  // 보기 범위 맞추기
  const pts = list.filter(d=>d.lat!=null).map(d=>[d.lat,d.lng]);
  if(pts.length){ map.fitBounds(pts, { padding:[50,50] }); }
  renderMissing();
}

function resetFilter(){
  document.querySelectorAll('.f-gu').forEach(x=>x.checked=true);
  document.querySelectorAll('.f-course').forEach(x=>x.checked=true);
  document.getElementById('dateStart').value='';
  document.getElementById('dateEnd').value='';
  applyFilter();
}

// 좌표 미설정 항목 렌더 + 선택 박스
function renderMissing(){
  const miss = DATA.filter(d=>d.lat==null || d.lng==null);
  const box = document.getElementById('missingList'); box.innerHTML='';
  if(!miss.length){ box.innerHTML = '<div class="note">모든 학교 좌표가 설정되었습니다 ✅</div>'; }
  else{
    miss.forEach(d=>{
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = `<h4>${d.school}</h4><div class="meta">${d.addr}</div>`;
      box.appendChild(c);
    });
  }
  const sel = document.getElementById('selPlace');
  sel.innerHTML = '<option value="">좌표를 지정할 학교 선택…</option>' + miss.map(m=>`<option value="${m.id}">${m.school} — ${m.addr}</option>`).join('');
}

// 좌표 찍기 인터랙션
let placingTarget = null, placingMarker = null;
function enterPlacingMode(item){
  placingTarget = item;
  alert(`[${item.school}]의 좌표를 설정할 위치를 지도에서 클릭하세요.`);
}

function onMapClick(e){
  if(!placingTarget) return;
  // 임시 마커
  if(placingMarker){ map.removeLayer(placingMarker); placingMarker=null; }
  placingMarker = L.marker(e.latlng).addTo(map);
  const ok = confirm(`${placingTarget.school}\n${placingTarget.addr}\n\n이 위치로 저장할까요?`);
  if(ok){
    setCoordFor(placingTarget, e.latlng);
    // DATA 갱신 후 다시 그림
    DATA = buildDataset(); applyFilter();
    if(placingMarker){ map.removeLayer(placingMarker); placingMarker=null; }
    placingTarget = null;
  }
}

function exportCoords(){
  const cache = loadCoordCache();
  const blob = new Blob([JSON.stringify(cache, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='coord_cache.json'; a.click();
  URL.revokeObjectURL(url);
}

// 초기 구동
function init(){
  initMap();
  renderLegend();
  buildCourseChecks();
  renderMissing();
  addMarkers(DATA);

  document.getElementById('btnApply').addEventListener('click', applyFilter);
  document.getElementById('btnReset').addEventListener('click', resetFilter);
  document.getElementById('btnToday').addEventListener('click', ()=>{document.getElementById('dateStart').value='';document.getElementById('dateEnd').value='';});
  document.getElementById('btnExport').addEventListener('click', exportCoords);
  document.getElementById('selPlace').addEventListener('change', (ev)=>{
    const id = ev.target.value; if(!id) return;
    const item = DATA.find(d=>d.id===id); if(item){ enterPlacingMode(item); }
  });
  map.on('click', onMapClick);

  // 더블클릭으로도 좌표설정
  map.on('dblclick', (e)=>{ if(placingTarget){ onMapClick(e); } });
}

init();
</script>
</body>
</html>
