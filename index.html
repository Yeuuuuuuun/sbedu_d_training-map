<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>연수 지도 — 서대문·마포·은평</title>

  <!-- dayjs -->
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/customParseFormat.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/locale/ko.js"></script>
  <script>
    dayjs.extend(window.dayjs_plugin_customParseFormat);
    dayjs.locale('ko');
  </script>

  <!-- Google Maps API (정적 로드) -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=__GOOGLE_MAPS_KEY__&libraries=geometry&callback=initGoogleMaps">
  </script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8f9fa; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
    .sidebar { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
      border-right: 1px solid rgba(0,0,0,0.05); padding: 24px; overflow-y: auto;
      box-shadow: 0 0 20px rgba(0,0,0,0.03); }
    .header { margin-bottom: 32px; }
    .title { font-size: 28px; font-weight: 700; color: #1d1d1f; margin-bottom: 8px; }
    .subtitle { color: #86868b; font-size: 15px; line-height: 1.4; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 17px; font-weight: 600; color: #1d1d1f; margin-bottom: 16px; }

    /* 날짜 선택 - 테이블 형태 */
    .date-selector { 
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.04); 
    }
    
    .month-header { 
      font-size: 18px; font-weight: 700; color: #1d1d1f; margin-bottom: 16px; 
      text-align: center; padding: 12px 0; 
      background: #f8f9fa; border-radius: 8px;
    }
    
    .calendar-table {
      width: 100%; border-collapse: separate; border-spacing: 2px;
      margin-bottom: 20px;
    }
    
    .weekday-header {
      font-size: 12px; font-weight: 600; color: #86868b; 
      text-align: center; padding: 10px 4px; text-transform: uppercase;
      letter-spacing: 0.5px; background: #f8f9fa;
      border-radius: 4px;
    }
    
    .date-cell { 
      width: 100%; height: 40px; border: 1px solid #e5e5ea; 
      background: white; border-radius: 4px;
      font-size: 14px; font-weight: 500; cursor: pointer; 
      transition: all .2s ease; color: #1d1d1f;
      text-align: center;
    }
    
    .date-cell:disabled { 
      color: #d1d1d6; cursor: not-allowed; 
      background: #f8f9fa; border-color: #f0f0f0;
    }
    
    .date-cell:not(:disabled):hover { 
      background: #f0f0f0; border-color: #007aff;
    }
    
    .date-cell.selected { 
      background: #007aff; color: white; border-color: #007aff;
      font-weight: 600;
    }
    
    .date-cell.has-training { 
      background: #e8f4fd; color: #007aff; font-weight: 600; 
      border-color: #007aff; position: relative;
    }
    
    .date-cell.has-training::after {
      content: '●';
      position: absolute;
      top: 2px; right: 4px;
      font-size: 8px; color: #007aff;
    }
    
    .date-cell.has-training.selected { 
      background: #007aff; color: white; border-color: #0056b3;
    }
    
    .date-cell.has-training.selected::after {
      color: white;
    }
    
    .calendar-controls {
      display: flex; gap: 10px; padding-top: 16px; 
      border-top: 1px solid #e5e5ea;
    }
    
    .calendar-btn {
      flex: 1; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all .2s ease; border: 1px solid;
    }
    
    .calendar-btn.select-all {
      background: white; color: #007aff; border-color: #007aff;
    }
    
    .calendar-btn.select-all:hover {
      background: #007aff; color: white;
    }
    
    .calendar-btn.clear-all {
      background: white; color: #ff3b30; border-color: #ff3b30;
    }
    
    .calendar-btn.clear-all:hover {
      background: #ff3b30; color: white;
    }

    /* 과정 필터 */
    .course-filters { display: grid; gap: 8px; }
    .course-filter { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #fff;
      border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.06);
      cursor: pointer; transition: all .2s ease; user-select: none; }
    .course-filter:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .course-filter.active { border-color: transparent; box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
    .course-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .course-name { font-size: 15px; font-weight: 500; color: #1d1d1f; flex: 1; }
    .course-toggle { width: 44px; height: 26px; background: #e5e5ea; border-radius: 13px; position: relative; transition: all .2s ease; }
    .course-toggle::after { content: ''; position: absolute; width: 22px; height: 22px; border-radius: 50%; background: #fff; top: 2px; left: 2px; transition: all .2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .course-filter.active .course-toggle { background: #34c759; }
    .course-filter.active .course-toggle::after { left: 20px; }

    /* 통계 */
    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
    .stat-card { background: #fff; border-radius: 12px; padding: 16px; text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.06); }
    .stat-number { font-size: 24px; font-weight: 700; color: #007aff; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: #86868b; font-weight: 500; }

    /* 지도 */
    #map { height: 100%; width: 100%; }

    /* 팝업 */
    .info-window { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; max-width: 300px; }
    .info-window h3 { margin: 0 0 8px; font-size: 16px; font-weight: 600; color: #1d1d1f; }
    .info-window .addr { color: #86868b; font-size: 13px; margin-bottom: 12px; }
    .info-window .sessions { display: grid; gap: 8px; }
    .info-window .session { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #f5f5f7; border-radius: 8px; }
    .info-window .course-badge { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; color: #fff; }
    .info-window .session-time { font-size: 13px; color: #1d1d1f; }

    @media (max-width: 768px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      .sidebar { padding: 16px; max-height: 320px; }
      .title { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="header">
        <div class="title">연수 지도</div>
        <div class="subtitle">서대문구 · 마포구 · 은평구<br>2025년 교사 연수 일정</div>
      </div>

      <div class="section">
        <div class="section-title">날짜 선택</div>
        <div class="date-selector">
          <div id="calendarContainer"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">연수 과정</div>
        <div class="course-filters" id="courseFilters"></div>
      </div>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-number" id="schoolCount">0</div>
          <div class="stat-label">학교</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="sessionCount">0</div>
          <div class="stat-label">연수</div>
        </div>
      </div>

      <div id="appError" style="margin-top:16px; color:#ef4444; font-weight:600;"></div>
    </div>

    <!-- 지도 영역 -->
    <div id="map"></div>
  </div>

  <script>
  // 전역 변수
  let _googleMap, _geocoder;
  let allData = [];
  let selectedDates = new Set();
  let activeCourses = new Set();
  let markers = [];
  let activeInfoWindow = null;

  // 연수 데이터
  const RAW = [
    ["S1","염리초","9.15.","14:30","16:10","①에듀테크 주토피아","서울 마포구 토정로37길 37"],
    ["S2","홍제초","9.16.","14:30","16:10","②AI관람차","서울 서대문구 홍은중앙로 13"],
    ["S3","어울초","9.16.","15:00","16:40","⑤평가 익스프레스","서울 은평구 통일로 650"],
    ["S4","인왕초","9.16.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 세무서길 33-9"],
    ["S5","가재울초","9.17.","14:00","15:40","④수업 바이킹","서울 서대문구 모래내로15길 61"],
    ["S6","연신초","9.17.","14:00","15:40","④수업 바이킹","서울 은평구 연서로 347"],
    ["S7","성산초","9.17.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 양화로3길 94"],
    ["S8","신사초","9.17.","14:50","16:30","②AI관람차","서울 은평구 가좌로 275-2"],
    ["S9","금화초","9.18.","15:00","16:40","①에듀테크 주토피아","서울 서대문구 통일로 165"],
    ["S10","금화초","9.18.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 통일로 165"],
    ["S11","은진초","9.22.","15:00","16:40","①에듀테크 주토피아","서울 은평구 진관1로 21-20"],
    ["S12","소의초","9.22.","15:00","16:40","②AI관람차","서울 마포구 마포대로24길 42"],
    ["S13","신도초","9.22.","15:00","16:40","①에듀테크 주토피아","서울 은평구 진관1로 77-23"],
    ["S14","홍연초","9.23.","14:30","16:10","①에듀테크 주토피아","서울 서대문구 백련사길 55"],
    ["S15","성원초","9.23.","15:00","16:40","⑦파라오의 학급경영","서울 마포구 월드컵로36길 34"],
    ["S16","구산초","9.24.","14:30","16:10","②AI관람차","서울 은평구 서오릉로15길 16"],
    ["S17","북성초","9.24.","14:30","16:10","⑦파라오의 학급경영","서울 서대문구 북아현로1나길 22"],
    ["S18","중동초","9.24.","14:40","16:20","④수업 바이킹","서울 마포구 월드컵북로 152"],
    ["S19","연은초","9.25.","14:40","16:10","⑤평가 익스프레스","서울 은평구 백련산로2길 35"],
    ["S20","마포초","9.29.","14:40","16:20","①에듀테크 주토피아","서울 마포구 도화2길 64"],
    ["S21","마포초","9.29.","14:40","16:20","②AI관람차","서울 마포구 도화2길 64"],
    ["S22","연광초","9.30.","14:30","16:10","②AI관람차","서울 은평구 연서로35길 37"],
    ["S23","경기초","9.30.","15:20","17:00","④수업 바이킹","서울 서대문구 경기대로9길 10"],
    ["S24","갈현초","10.1.","14:40","16:20","④수업 바이킹","서울 은평구 연서로29길 31"],
    ["S25","증산초","10.13.","15:00","16:40","⑦파라오의 학급경영","서울 은평구 증산서길 61"],
    ["S26","신북초","10.14.","14:50","16:20","⑤평가 익스프레스","서울 마포구 월드컵북로38길 26"],
    ["S27","명지초","10.15.","15:00","16:40","⑥업무 레볼루션","서울 서대문구 명지2길 32-20"],
    ["S28","수색초","10.15.","15:00","16:40","④수업 바이킹","서울 은평구 수색로16길 21"],
    ["S29","예일초","10.20.","14:30","16:10","①에듀테크 주토피아","서울 은평구 연서로 117"],
    ["S30","이대부초","10.21.","15:30","17:10","④수업 바이킹","서울 서대문구 성산로 512-39"],
    ["S31","고은초","10.22.","15:00","16:40","④수업 바이킹","서울 서대문구 모래내로 441"],
    ["S32","응암초","10.22.","14:30","16:10","⑤평가 익스프레스","서울 은평구 가좌로6길 20"],
    ["S33","응암초","10.22.","14:30","16:10","⑥업무 레볼루션","서울 은평구 가좌로6길 20"],
    ["S34","구현초","11.3.","14:50","16:30","②AI관람차","서울 은평구 갈현로15길 51"],
    ["S35","수리초","11.3.","15:00","16:40","②AI관람차","서울 은평구 불광로14길 10-10"],
    ["S36","대은초","11.4.","14:30","16:10","⑥업무 레볼루션","서울 은평구 통일로69길 12-15"],
    ["S37","녹번초","11.5.","14:00","15:40","⑥업무 레볼루션","서울 은평구 녹번로1길 1"],
    ["S38","녹번초","11.5.","14:00","15:40","②AI관람차","서울 은평구 녹번로1길 1"],
    ["S39","안산초","11.5.","14:00","15:40","⑦파라오의 학급경영","서울 서대문구 통일로 321"],
    ["S40","충암초","11.5.","14:30","15:10","⑥업무 레볼루션","서울 은평구 가좌로5길 5"],
    ["S41","공덕초","11.11.","14:30","16:20","⑥업무 레볼루션","서울 마포구 만리재옛길 13"],
    ["S42","한서초","11.12.","14:00","15:40","①에듀테크 주토피아","서울 마포구 대흥로24바길 27"],
    ["S43","아현초","11.12.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 굴레방로 6"],
    ["S44","상암초","11.17.","14:50","16:30","⑥업무 레볼루션","서울 마포구 월드컵북로 353"],
    ["S45","불광초","11.19.","14:30","16:10","⑥업무 레볼루션","서울 은평구 불광로 51"],
    ["S46","홍대부초","11.19.","14:30","16:10","⑦파라오의 학급경영","서울 마포구 성미산로 51"]
  ];

  const COURSES = {
    '①에듀테크 주토피아': { name: '에듀테크 주토피아', color: '#34c759' },
    '②AI관람차': { name: 'AI관람차', color: '#007aff' },
    '④수업 바이킹': { name: '수업 바이킹', color: '#ff3b30' },
    '⑤평가 익스프레스': { name: '평가 익스프레스', color: '#ff9500' },
    '⑥업무 레볼루션': { name: '업무 레볼루션', color: '#af52de' },
    '⑦파라오의 학급경영': { name: '파라오의 학급경영', color: '#ff2d92' }
  };

  const SEOUL_CENTER = { lat: 37.5665, lng: 126.9780 };

  // 유틸리티 함수들
  function parseDate(dateStr) {
    const cleaned = String(dateStr).replace(/\s*/g, '');
    const [month, day] = cleaned.split('.').filter(Boolean);
    return `2025-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  }

  function cleanCourseName(name) {
    return String(name).replace(/^[^\w가-힣]+/, '');
  }

  function buildDataset() {
    const schoolMap = new Map();
    RAW.forEach(row => {
      const [id, school, dateStr, startTime, endTime, course, addr] = row;
      const date = parseDate(dateStr);
      const startDateTime = dayjs(`${date} ${startTime}`, 'YYYY-MM-DD HH:mm');
      const endDateTime = dayjs(`${date} ${endTime}`, 'YYYY-MM-DD HH:mm');

      const key = `${school}@@${addr}`;
      if (!schoolMap.has(key)) {
        schoolMap.set(key, {
          id: key, school, addr,
          lat: SEOUL_CENTER.lat, lng: SEOUL_CENTER.lng,
          sessions: [], courses: new Set()
        });
      }
      const item = schoolMap.get(key);
      item.sessions.push({
        id, date: startDateTime.format('YYYY-MM-DD'),
        startTime: startDateTime.format('HH:mm'),
        endTime: endDateTime.format('HH:mm'),
        course
      });
      item.courses.add(course);
    });
    return Array.from(schoolMap.values()).map(v => ({ ...v, courses: Array.from(v.courses) }));
  }

  // Google Maps 초기화 및 앱 시작
  function initGoogleMaps() {
    console.log('Google Maps API 로드 완료');
    
    // 지도 초기화 (휠 줌 활성화)
    _googleMap = new google.maps.Map(document.getElementById('map'), {
      center: SEOUL_CENTER,
      zoom: 11,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
      scrollwheel: true,
      gestureHandling: 'greedy'
    });
    
    _geocoder = new google.maps.Geocoder();
    
    // 앱 시작
    initApp();
  }

  function createInfoWindowContent(item) {
    const sessionsHTML = item.sessions
      .sort((a,b) => (a.date + a.startTime).localeCompare(b.date + b.startTime))
      .map(s => {
        const courseInfo = COURSES[s.course];
        const dateObj = dayjs(s.date);
        return `
          <div class="session">
            <div class="course-badge" style="background:${courseInfo?.color || '#666'}">${cleanCourseName(courseInfo?.name || s.course)}</div>
            <div class="session-time">${dateObj.format('M.D(dd)')} ${s.startTime}~${s.endTime}</div>
          </div>
        `;
      }).join('');
    return `
      <div class="info-window">
        <h3>${item.school}</h3>
        <div class="addr">${item.addr}</div>
        <div class="sessions">${sessionsHTML}</div>
      </div>
    `;
  }

  async function initApp() {
    console.log('앱 초기화 시작');
    
    // 과정 필터 초기화
    activeCourses = new Set(Object.keys(COURSES));
    
    allData = buildDataset();
    await fixAllCoords(allData);
    createCalendar();
    createCourseFilters();
    updateMarkers();
    
    console.log('앱 초기화 완료');
  }

  // 지오코딩
  const GEO_CACHE_PREFIX = 'google::geocode::';
  function getGeoCache(addr) {
    try { 
      const raw = localStorage.getItem(GEO_CACHE_PREFIX + addr); 
      return raw ? JSON.parse(raw) : null; 
    } catch { 
      return null; 
    }
  }
  
  function setGeoCache(addr, lat, lng) {
    try { 
      localStorage.setItem(GEO_CACHE_PREFIX + addr, JSON.stringify({lat,lng})); 
    } catch {}
  }
  
  function geocodeAddress(addr) {
    return new Promise((resolve) => {
      const cached = getGeoCache(addr);
      if (cached && cached.lat && cached.lng) return resolve(cached);
      
      _geocoder.geocode({ address: addr }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const location = results[0].geometry.location;
          const lat = location.lat();
          const lng = location.lng();
          setGeoCache(addr, lat, lng);
          resolve({ lat, lng });
        } else {
          resolve(null);
        }
      });
    });
  }
  
  async function fixAllCoords(list) {
    for (const item of list) {
      const r = await geocodeAddress(item.addr);
      if (r) { 
        item.lat = r.lat; 
        item.lng = r.lng; 
      }
      await new Promise(r => setTimeout(r, 100));
    }
  }

  // UI 생성 - 테이블 형태 달력
  function createCalendar() {
    const container = document.getElementById('calendarContainer');
    const allDates = new Set();
    allData.forEach(i => i.sessions.forEach(s => allDates.add(s.date)));
    const monthGroups = {};
    Array.from(allDates).forEach(d => (monthGroups[d.substring(0,7)] ||= []).push(d));

    container.innerHTML = '';
    
    Object.keys(monthGroups).sort().forEach(month => {
      const monthDiv = document.createElement('div');
      
      // 월 헤더
      const monthHeader = document.createElement('div');
      monthHeader.className = 'month-header';
      monthHeader.textContent = dayjs(month).format('YYYY년 M월');
      monthDiv.appendChild(monthHeader);
      
      // 테이블 생성
      const table = document.createElement('table');
      table.className = 'calendar-table';
      
      // 요일 헤더
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      weekdays.forEach(day => {
        const th = document.createElement('th');
        th.className = 'weekday-header';
        th.textContent = day;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // 달력 본체
      const tbody = document.createElement('tbody');
      
      // 해당 월의 첫 날과 마지막 날 계산
      const firstDay = dayjs(month + '-01');
      const lastDay = firstDay.endOf('month');
      const startDate = firstDay.startOf('week');
      const endDate = lastDay.endOf('week');
      
      // 주별로 행 생성
      let currentDate = startDate;
      while (currentDate.isBefore(endDate) || currentDate.isSame(endDate)) {
        const row = document.createElement('tr');
        
        // 일주일 생성
        for (let i = 0; i < 7; i++) {
          const cell = document.createElement('td');
          const btn = document.createElement('button');
          btn.className = 'date-cell';
          btn.type = 'button';
          btn.textContent = currentDate.format('D');
          
          const dateStr = currentDate.format('YYYY-MM-DD');
          const isCurrentMonth = currentDate.format('YYYY-MM') === month;
          const hasTraining = allDates.has(dateStr);
          
          if (!isCurrentMonth) {
            btn.disabled = true;
          } else if (hasTraining) {
            btn.classList.add('has-training');
            btn.title = `${currentDate.format('M월 D일 (ddd)')} - 연수 있음`;
            
            btn.addEventListener('click', () => {
              const isSelected = selectedDates.has(dateStr);
              if (isSelected) {
                selectedDates.delete(dateStr);
                btn.classList.remove('selected');
              } else {
                selectedDates.add(dateStr);
                btn.classList.add('selected');
              }
              updateMarkers();
            });
          } else {
            btn.title = currentDate.format('M월 D일 (ddd)');
          }
          
          cell.appendChild(btn);
          row.appendChild(cell);
          currentDate = currentDate.add(1, 'day');
        }
        
        tbody.appendChild(row);
      }
      
      table.appendChild(tbody);
      monthDiv.appendChild(table);
      container.appendChild(monthDiv);
    });

    // 컨트롤 버튼
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'calendar-controls';
    
    const selectAllBtn = document.createElement('button');
    selectAllBtn.textContent = '전체 선택';
    selectAllBtn.className = 'calendar-btn select-all';
    selectAllBtn.addEventListener('click', () => {
      allDates.forEach(d => selectedDates.add(d));
      container.querySelectorAll('.date-cell.has-training').forEach(b => {
        b.classList.add('selected');
      });
      updateMarkers();
    });
    
    const clearAllBtn = document.createElement('button');
    clearAllBtn.textContent = '전체 해제';
    clearAllBtn.className = 'calendar-btn clear-all';
    clearAllBtn.addEventListener('click', () => {
      selectedDates.clear();
      container.querySelectorAll('.date-cell').forEach(b => {
        b.classList.remove('selected');
      });
      updateMarkers();
    });
    
    controlsDiv.appendChild(selectAllBtn);
    controlsDiv.appendChild(clearAllBtn);
    container.appendChild(controlsDiv);
  }

  function createCourseFilters() {
    const container = document.getElementById('courseFilters');
    container.innerHTML = '';
    Object.entries(COURSES).forEach(([key, info]) => {
      const filterDiv = document.createElement('div');
      filterDiv.className = 'course-filter active';
      filterDiv.innerHTML = `
        <div class="course-dot" style="background:${info.color}"></div>
        <div class="course-name">${info.name}</div>
        <div class="course-toggle"></div>
      `;
      filterDiv.addEventListener('click', () => {
        if (activeCourses.has(key)) {
          activeCourses.delete(key);
          filterDiv.classList.remove('active');
        } else {
          activeCourses.add(key);
          filterDiv.classList.add('active');
        }
        updateMarkers();
      });
      container.appendChild(filterDiv);
    });
  }

  // 마커 관리 - 라벨 기능 포함
  function createGoogleMarker(item) {
    const primaryColor = COURSES[item.courses[0]]?.color || '#666';
    
    // 더 큰 마커
    const svgMarker = {
      path: 'M12,2C8.13,2 5,5.13 5,9c0,5.25 7,13 7,13s7,-7.75 7,-13C19,5.13 15.87,2 12,2z',
      fillColor: primaryColor,
      fillOpacity: 1,
      strokeWeight: 3,
      strokeColor: '#ffffff',
      scale: 2.2
    };

    const marker = new google.maps.Marker({
      position: { lat: item.lat, lng: item.lng },
      map: _googleMap,
      icon: svgMarker,
      title: item.school
    });

    // 기본 학교 이름 라벨
    const label = new google.maps.InfoWindow({
      content: `<div style="font-weight: 600; color: #1d1d1f; font-size: 14px; padding: 4px 8px; background: rgba(255,255,255,0.95); border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: none;">${item.school}</div>`,
      disableAutoPan: true,
      pixelOffset: new google.maps.Size(0, -60)
    });

    // 상세 정보창
    const infoWindow = new google.maps.InfoWindow({
      content: createInfoWindowContent(item)
    });

    // 기본적으로 라벨 표시
    label.open(_googleMap, marker);

    // 클릭 시 라벨 숨기고 상세 정보 표시
    marker.addListener('click', () => {
      // 다른 정보창들 닫기
      if (activeInfoWindow) activeInfoWindow.close();
      
      // 라벨 숨기기
      label.close();
      
      // 상세 정보창 열기
      infoWindow.open(_googleMap, marker);
      activeInfoWindow = infoWindow;
    });

    // 상세 정보창이 닫히면 라벨 다시 표시
    infoWindow.addListener('closeclick', () => {
      label.open(_googleMap, marker);
      activeInfoWindow = null;
    });

    // 마커 객체에 라벨과 정보창 참조 저장
    marker.label = label;
    marker.infoWindow = infoWindow;

    return marker;
  }

  function updateMarkers() {
    // 기존 마커 제거
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    
    if (activeInfoWindow) {
      activeInfoWindow.close();
      activeInfoWindow = null;
    }

    const filtered = allData.filter(item => {
      const hasCourse = item.courses.some(c => activeCourses.has(c));
      if (!hasCourse) return false;
      if (selectedDates.size > 0) {
        const hasDate = item.sessions.some(s => selectedDates.has(s.date));
        if (!hasDate) return false;
      }
      return true;
    });

    // 새 마커 생성
    markers = filtered.map(createGoogleMarker);
    
    updateStats(filtered);

    // 지도 뷰 조정
    if (filtered.length === 1) {
      _googleMap.setCenter({ lat: filtered[0].lat, lng: filtered[0].lng });
      _googleMap.setZoom(15);
    } else if (filtered.length > 1) {
      const bounds = new google.maps.LatLngBounds();
      filtered.forEach(item => {
        bounds.extend(new google.maps.LatLng(item.lat, item.lng));
      });
      _googleMap.fitBounds(bounds);
      
      google.maps.event.addListenerOnce(_googleMap, 'bounds_changed', () => {
        if (_googleMap.getZoom() > 15) {
          _googleMap.setZoom(15);
        }
      });
    } else {
      _googleMap.setCenter(SEOUL_CENTER);
      _googleMap.setZoom(11);
    }
  }

  function updateStats(data) {
    const schoolCount = data.length;
    const sessionCount = data.reduce((sum, item) => {
      return sum + item.sessions.filter(s => {
        if (selectedDates.size > 0 && !selectedDates.has(s.date)) return false;
        if (!activeCourses.has(s.course)) return false;
        return true;
      }).length;
    }, 0);

    document.getElementById('schoolCount').textContent = schoolCount;
    document.getElementById('sessionCount').textContent = sessionCount;
  }

  // 에러 처리
  window.onerror = function(msg, url, line) {
    console.error('JavaScript Error:', msg, 'at', url + ':' + line);
    document.getElementById('appError').textContent = 'JavaScript 오류가 발생했습니다: ' + msg;
  };

  // Google Maps API 로드 실패 처리
  window.gm_authFailure = function() {
    document.getElementById('appError').textContent = 'Google Maps API 키가 유효하지 않거나 권한이 없습니다.';
  };

  console.log('스크립트 로드 완료, Google Maps API 대기 중...');
  </script>
</body>
</html>
